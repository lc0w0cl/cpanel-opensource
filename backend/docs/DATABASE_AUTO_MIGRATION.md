# 数据库自动迁移功能

## 概述

本系统实现了数据库表结构的自动检测和创建功能，无需手动执行SQL脚本。当应用启动时，系统会自动：

1. 检查数据库版本
2. 检测缺失的表结构
3. 自动创建所需的表
4. 更新表结构（如添加新字段）
5. 更新数据库版本号

## 功能特性

### 🚀 无感升级
- 应用启动时自动检测数据库状态
- 自动创建缺失的表结构
- 无需手动执行SQL脚本
- 支持增量更新

### 📊 版本管理
- 自动跟踪数据库版本
- 支持版本间的平滑升级
- 版本信息存储在系统配置表中

### 🛡️ 安全可靠
- 使用 `IF NOT EXISTS` 确保安全创建
- 详细的日志记录
- 异常处理不影响应用启动

## 实现架构

### 核心组件

1. **DatabaseInitService**: 数据库初始化服务
   - 检查表是否存在
   - 创建缺失的表
   - 更新表结构

2. **DatabaseVersionService**: 版本管理服务
   - 跟踪数据库版本
   - 执行版本升级
   - 版本兼容性检查

3. **ApplicationStartupListener**: 启动监听器
   - 应用启动时触发初始化
   - 统一的初始化入口

### 执行流程

```
应用启动
    ↓
ApplicationStartupListener
    ↓
DatabaseInitService.initializeTables()
    ↓
DatabaseVersionService.checkAndUpgrade()
    ↓
检查TODO表是否存在
    ↓
创建缺失的表
    ↓
更新表结构
    ↓
完成初始化
```

## 支持的操作

### 表创建
- `panel_todos`: TODO任务表
- 自动创建索引
- 设置字符集和排序规则

### 表结构更新
- 添加新字段（如 config_type）
- 创建新索引
- 更新现有数据

### 版本升级
- 1.0.0 → 1.1.0: 添加TODO功能
- 支持多版本升级路径

## 配置说明

### 数据库版本
当前版本: `1.1.0`
存储位置: `panel_system_config` 表中的 `database_version` 配置项

### 版本历史
- `1.0.0`: 基础版本（系统配置、导航等）
- `1.1.0`: 添加TODO功能

## 日志输出

启动时会看到类似的日志：

```
=== 应用启动完成，开始执行初始化操作 ===
正在执行数据库初始化...
开始检查数据库表结构...
检测到数据库需要升级: 1.0.0 -> 1.1.0
执行1.0.0到1.1.0的数据库升级...
数据库版本已更新为: 1.1.0
TODO表不存在，开始创建...
TODO表创建SQL执行成功
TODO表创建成功
数据库表结构检查完成
=== 应用初始化操作完成，耗时: 156ms ===
🎉 CPanel应用启动成功！
📊 TODO功能已就绪，数据将自动持久化到数据库
```

## 错误处理

### 常见问题

1. **数据库连接失败**
   - 检查数据库配置
   - 确认数据库服务运行状态

2. **权限不足**
   - 确保数据库用户有CREATE TABLE权限
   - 检查ALTER TABLE权限

3. **表已存在冲突**
   - 系统使用 `IF NOT EXISTS` 避免冲突
   - 不会影响现有数据

### 故障恢复

如果初始化失败：
1. 检查日志中的错误信息
2. 确认数据库连接和权限
3. 重启应用自动重试
4. 必要时手动执行SQL脚本

## 扩展指南

### 添加新表

1. 在 `DatabaseInitService` 中添加检查方法
2. 实现表创建逻辑
3. 在 `initializeTables()` 中调用

### 版本升级

1. 更新 `CURRENT_VERSION` 常量
2. 在 `DatabaseVersionService` 中添加升级逻辑
3. 实现具体的升级方法

### 示例代码

```java
// 检查新表
if (!checkNewTableExists()) {
    log.info("新表不存在，开始创建...");
    createNewTable();
}

// 版本升级
if ("1.1.0".equals(fromVersion) && "1.2.0".equals(toVersion)) {
    return upgradeFrom1_1_0To1_2_0();
}
```

## 最佳实践

1. **向后兼容**: 新版本应兼容旧数据
2. **增量更新**: 只添加必要的变更
3. **详细日志**: 记录所有操作步骤
4. **异常处理**: 不影响应用正常启动
5. **测试验证**: 在测试环境验证升级逻辑

## 注意事项

1. 首次启动可能需要较长时间（创建表）
2. 升级过程中不要中断应用
3. 建议在升级前备份数据库
4. 生产环境部署前先在测试环境验证

## 监控建议

1. 监控启动时间
2. 检查初始化日志
3. 验证表结构正确性
4. 确认数据完整性
